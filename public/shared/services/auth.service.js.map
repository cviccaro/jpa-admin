{"version":3,"sources":["shared/services/auth.service.ts"],"names":[],"mappings":"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","file":"shared/services/auth.service.js","sourcesContent":["import { Injectable, EventEmitter } from '@angular/core';\nimport { Http, URLSearchParams, Headers } from '@angular/http';\nimport { Observable } from 'rxjs/Rx';\nimport { AuthHttp, JwtHelper } from 'angular2-jwt';\n\nimport { ReplaySubject } from 'rxjs/ReplaySubject';\nimport { LoggerService } from './logger.service';\n\n// import {LocalStorageService} from \"angular2-localstorage/LocalStorageEmitter\";\n// import {LocalStorage, SessionStorage} from \"angular2-localstorage/WebStorage\";\n\n@Injectable()\nexport class AuthService {\n    private _authorized = false;\n    hasStorage = !(localStorage === undefined);\n   // @LocalStorage() public token: string = '';\n    private token = '';\n    private expires: number;\n\n    // Observable source\n    private _authTokenSource = new ReplaySubject<string>(1);\n    // Observable stream\n    public authToken$ = this._authTokenSource.asObservable();\n\n    // source\n    private _authorizedSource = new ReplaySubject<boolean>(1);\n\n    // stream\n    public whenAuthorized = this._authorizedSource.asObservable();\n\n    constructor(private http: Http, private authHttp: AuthHttp, private helper: JwtHelper, private log: LoggerService) {\n        if (this.hasStorage) {\n            ['token', 'expires'].forEach(key => {\n                let val = localStorage.getItem(`id_${key}`);\n                if (val) this[key] = val;\n            });\n        } else {\n            this.log.warn('authService#local storage is not supported.');\n        }\n\n        // @todo: check token.\n        if (this.token != '') {\n            this.log.log('authService#Found authorization token in localStorage.  Checking expiration date...');\n            if (this.expires !== undefined && this.timeLeft(this.expires) > 0) {\n                this.authorized = true;\n                //this.log.log('authService#PASS: Authorization token is still valid for ' + this.timeLeft(this.expires) + ' seconds.');\n            } else {\n                this.log.log('authService#FAIL: Authorization token expired on ',this.expires);\n                this.refresh()\n                    .subscribe(res => {\n                        this.log.log('refresh response to subscription receiver', res);\n                    });\n            }\n        } else {\n            this.log.log('authService#no token found in storage.');\n        }\n\n        this.log.log('authService#init END', this);\n    }\n\n    get authorized() { return this._authorized; }\n    set authorized(v: boolean) {\n        this._authorized = v;\n        this._authorizedSource.next(v);\n    }\n\n    timeLeft(expires) {\n        return expires - (new Date().getTime() / 1000);\n    }\n\n    setToken(token) {\n        if (this.hasStorage) localStorage.setItem('id_token', token);\n        this.token = token;\n        this.informObservers(token);\n        return this;\n    }\n\n    getToken() {\n        return this.token;\n    }\n\n    informObservers(token?:string) {\n        if (token === undefined) token = this.token;\n\n        this._authTokenSource.next(token);\n    }\n\n    setExpires(expires) {\n        if (this.hasStorage) localStorage.setItem('id_expires', expires);\n        this.expires = expires;\n        return this;\n    }\n\n    login(email: string, password: string) : Observable<any> {\n        this.log.log('authService#login: ', email, password);\n        return Observable.create(observer => {\n            this.http.post('authenticate', { email: email, password: password })\n                .map(res => res.json())\n                .subscribe(\n                    res => {\n                        this.setToken(res.token);\n                        this.setExpires(res.expires);\n                        this.authorized = true;\n                        observer.next(res);\n                    },\n                    error => observer.error(this.parseError(error))\n                );\n        });\n    }\n\n    refresh() {\n        this.log.log('authService#refresh');\n        return Observable.create(observer => {\n            let headers = new Headers({'Authorization': 'Bearer ' + this.token});\n            this.http.get('authenticate/refresh', {headers: headers})\n                .map(res => res.json())\n                .subscribe(\n                    res => {\n                        this.log.log('authService#refresh Success', res);\n                        this.setToken(res.token);\n                        this.setExpires(res.expires);\n                        this.authorized = true;\n                        observer.next(res);\n                    },\n                    error => {\n                        this.log.log('error in jwt refresh ', error);\n                        observer.error(error);\n                        //observer.error(this.parseError(error)\n                    }\n                );\n        });\n\n    }\n\n    reset() {\n        this.authorized = false;\n\n        this.token = '';\n        if (this.hasStorage) localStorage.removeItem('id_token');\n\n        this.expires = undefined;\n        if (this.hasStorage) localStorage.removeItem('id_expires');\n    }\n\n    parseError(error) : {title: string, message: string} {\n        let title = 'Error';\n        let message = \"Something went wrong and I'm not sure what.  Try again later.\";\n\n        if (error.status === 500) {\n            title = 'Server Error';\n            message = 'An error occured on the server.  Come back later and try again.';\n        } else {\n            try {\n                let json = JSON.parse(error._body);\n                message = json.errorText || json.error;\n\n                if (json.error === 'invalid_credentials') title = 'Login failed';\n            } catch (e) {\n                this.log.log('authService#parseError couldnt parse the json: ', {\n                    error: error,\n                    reason: e\n                });\n            }\n        }\n\n        return { title: title, message: message };\n    }\n}\n"],"sourceRoot":"/source/"}