{"version":3,"sources":["shared/services/auth.service.ts"],"names":[],"mappings":"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","file":"shared/services/auth.service.js","sourcesContent":["import { Injectable, OnInit } from '@angular/core';\r\nimport { Http, URLSearchParams, Headers } from '@angular/http';\r\nimport { Observable } from 'rxjs/Rx';\r\nimport { AuthHttp, JwtHelper } from 'angular2-jwt';\r\n// import {LocalStorageService} from \"angular2-localstorage/LocalStorageEmitter\";\r\n// import {LocalStorage, SessionStorage} from \"angular2-localstorage/WebStorage\";\r\n\r\n@Injectable()\r\nexport class AuthService implements OnInit {\r\n    authorized = false;\r\n    hasStorage = !(localStorage === undefined);\r\n   // @LocalStorage() public token: string = '';\r\n    private token = '';\r\n    private expires: number;\r\n\r\n    constructor(private http: Http, private authHttp: AuthHttp, private helper: JwtHelper) {\r\n        this.ngOnInit();\r\n    }\r\n\r\n    ngOnInit() {\r\n        if (this.hasStorage) {\r\n            ['token', 'expires'].forEach(key => {\r\n                let val = localStorage.getItem(`id_${key}`);\r\n                if (val) this[key] = val;\r\n            });\r\n        } else {\r\n            console.warn('authService#local storage is not supported.');\r\n        }\r\n\r\n        // @todo: check token.\r\n        if (this.token != '') {\r\n            console.log('authService#Found authorization token in localStorage.  Checking expiration date...');\r\n            if (this.expires !== undefined && this.timeLeft(this.expires) > 0) {\r\n                this.authorized = true;\r\n                console.log('authService#PASS: Authorization token is still valid for ' + this.timeLeft(this.expires) + ' seconds.');\r\n            } else {\r\n                console.log('authService#FAIL: Authorization token expired on ',this.expires);\r\n                this.refresh()\r\n                    .subscribe(res => {\r\n                        console.log('refresh response to subscription receiver', res);\r\n                    });\r\n            }\r\n        } else {\r\n            console.log('authService#no token found in storage.');\r\n        }\r\n\r\n        console.log('authService#init END', this);\r\n    }\r\n\r\n    timeLeft(expires) {\r\n        return expires - (new Date().getTime() / 1000);\r\n    }\r\n\r\n    setToken(token) {\r\n        if (this.hasStorage) localStorage.setItem('id_token', token);\r\n        this.token = token;\r\n        return this;\r\n    }\r\n\r\n    getToken() {\r\n        return this.token;\r\n    }\r\n\r\n    setExpires(expires) {\r\n        if (this.hasStorage) localStorage.setItem('id_expires', expires);\r\n        this.expires = expires;\r\n        return this;\r\n    }\r\n\r\n    login(email: string, password: string) : Observable<any> {\r\n        console.log('authService#login: ', email, password);\r\n        return Observable.create(observer => {\r\n            this.http.post('authenticate', { email: email, password: password })\r\n                .map(res => res.json())\r\n                .subscribe(\r\n                    res => {\r\n                        this.setToken(res.token);\r\n                        this.setExpires(res.expires);\r\n                        this.authorized = true;\r\n                        observer.next(res);\r\n                    },\r\n                    error => observer.error(this.parseError(error))\r\n                );\r\n        });\r\n    }\r\n\r\n    refresh() {\r\n        console.log('authService#refresh');\r\n        return Observable.create(observer => {\r\n            let headers = new Headers({'Authorization': 'Bearer ' + this.token});\r\n            this.http.get('authenticate/refresh', {headers: headers})\r\n                .map(res => res.json())\r\n                .subscribe(\r\n                    res => {\r\n                        console.log('authService#refresh Success', res);\r\n                        this.setToken(res.token);\r\n                        this.setExpires(res.expires);\r\n                        this.authorized = true;\r\n                        observer.next(res);\r\n                    },\r\n                    error => {\r\n                        console.log('error in jwt refresh ', error);\r\n                        observer.error(error);\r\n                        //observer.error(this.parseError(error)\r\n                    }\r\n                );\r\n        });\r\n\r\n    }\r\n\r\n    reset() {\r\n        this.authorized = false;\r\n\r\n        // this.token = '';\r\n        // if (this.hasStorage) localStorage.removeItem('id_token');\r\n\r\n        // this.expires = undefined;\r\n        // if (this.hasStorage) localStorage.removeItem('id_expires');\r\n    }\r\n\r\n    parseError(error) : {title: string, message: string} {\r\n        let title = 'Error';\r\n        let message = \"Something went wrong and I'm not sure what.  Try again later.\";\r\n\r\n        if (error.status === 500) {\r\n            title = 'Server Error';\r\n            message = 'An error occured on the server.  Come back later and try again.';\r\n        } else {\r\n            try {\r\n                let json = JSON.parse(error._body);\r\n                message = json.errorText || json.error;\r\n\r\n                if (json.error === 'invalid_credentials') title = 'Login failed';\r\n            } catch (e) {\r\n                console.log('authService#parseError couldnt parse the json: ', {\r\n                    error: error,\r\n                    reason: e\r\n                });\r\n            }\r\n        }\r\n\r\n        return { title: title, message: message };\r\n    }\r\n}\r\n"],"sourceRoot":"/source/"}